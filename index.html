<!DOCTYPE html>
<html>
  <head>
    <link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet">
  </head>
  
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <!-- we import arjs version without NFT but with marker + location based support -->
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
  <script src="https://cdn.rawgit.com/donmccurdy/aframe-extras/v5.0.0/dist/aframe-extras.min.js"></script>

  <script>
    AFRAME.registerComponent('registerevents', {
      init: function () {
        var marker = this.el;

        marker.addEventListener('markerFound', function() {
          var markerId = marker.id;
          console.log('markerFound', markerId);

          // TODO: Add your own code here to react to the marker being found.
          toggleoverlay();
          IsmessageOn = true;
          message = returnmessage(markerId);
          startTypewriter(markerId, message);
        });

        marker.addEventListener('markerLost', function() {
          var markerId = marker.id;
          console.log('markerLost', markerId);

          // TODO: Add your own code here to react to the marker being lost.
          toggleoverlay();
          IsmessageOn = false;
        });
      }
    });

    let charIndex = 0;
    let IsmessageOn = true;

    function startTypewriter(markerId, message) {
      if (!IsmessageOn) {
        return;
      }
      const divelement = document.getElementById('screen-text-overlay');
      divelement.style.display = 'flex';

      const outputElement = document.getElementById('typewriter-output');
      const fullMessage = message;
      console.log(fullMessage)
      const speed = 150; // 150ãƒŸãƒªç§’/æ–‡å­—
      
      if (charIndex < fullMessage.length) {
        // ä¸€æ–‡å­—è¿½åŠ ã—ã¦è¡¨ç¤ºã‚’æ›´æ–°
        outputElement.innerText = fullMessage.substring(0, charIndex + 1);
        charIndex++;


        // æ¬¡ã®æ–‡å­—ã‚’å¾…ã¤
        setTimeout(() => {
          // æ¬¡å›å‘¼ã³å‡ºã—æ™‚ã‚‚åŒã˜å¼•æ•°ã‚’ä½¿ã†
          startTypewriter(markerId, message); 
        }, speed);
        
      }
    }

    async function loadmessage() {
      const response = await fetch('message.json');

      if(!response.ok) {
        console.log("JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸ");
      }

      const JSONmessage = await response.json();
      
      return JSONmessage.characters;
      
    }

    let charJSON;
    
    (async () => {
      // loadmessage() ã®å®Œäº†ã‚’å¾…ã¡ã€è§£æ±ºã•ã‚ŒãŸå€¤ï¼ˆã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ï¼‰ã‚’ kuma å¤‰æ•°ã«ä»£å…¥ã™ã‚‹
      charJSON = await loadmessage();
      
      // ã“ã“ã§ã¯ 'kuma' ã¯ Promise ã§ã¯ãªãã€ãƒ‡ãƒ¼ã‚¿ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ãªã£ã¦ã„ã‚‹
      if (charJSON) {
          console.log(charJSON); // æœŸå¾…é€šã‚Šã« "ãã¾" ãŒè¡¨ç¤ºã•ã‚Œã‚‹
      } else {
          console.log("ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
      }
    })();
    
    function returnmessage(markerId) {
      const charactersjson = charJSON.find(char => char.id === markerId);
      return charactersjson.dialogue[0];
    }

    
    function toggleoverlay() {
      const overlay = document.getElementById('full-screen-overlay');
      if (overlay.style.display == 'flex') {
        overlay.style.display = 'none';
      } else {
        overlay.style.display = 'flex';
      }
    }

    function showelement(id) {
      const element = document.getElementById(id);
      element.style.display = 'flex';
    }

    function hideelement(id) {
      const element = document.getElementById(id);
      element.style.display = 'none';
    }

    document.addEventListener('DOMContentLoaded', () => {
      // å¤‰æ›´ã‚’ç›£è¦–ã™ã‚‹ãƒãƒ¼ãƒ‰ã‚’é¸æŠ
      const targetNode = document.body;
  
      // (å¤‰æ›´ã‚’ç›£è¦–ã™ã‚‹) ã‚ªãƒ–ã‚¶ãƒ¼ãƒãƒ¼ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³
      const config = { attributes: true, childList: true, subtree: true };
  
      // å¤‰æ›´ãŒç™ºè¦‹ã•ã‚ŒãŸã¨ãã«å®Ÿè¡Œã•ã‚Œã‚‹ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°
      const callback = (mutationList, observer) => {
        for (const mutation of mutationList) {
          mutation.addedNodes.forEach(node => {
            if (node.id == 'error-popup') {
              console.log('error-popupã‚’ç™ºè¦‹ã—ã¾ã—ãŸï¼');

              hideelement(node.id);
              showelement('permission-denied-overlay');

              hideelement('loading-overlay');
              observer.disconnect();
              return;
              
            } else if (node.id == 'arjs-video') {
              console.log('videoè¦ç´ ã‚’ç™ºè¦‹ã—ã¾ã—ãŸ');
              
              showelement('full-screen-overlay');
              hideelement('loading-overlay');

              observer.disconnect();
              return;
            }
          });
        }
      };
  
      // ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã«çµã³ã¤ã‘ã‚‰ã‚ŒãŸã‚ªãƒ–ã‚¶ãƒ¼ãƒãƒ¼ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç”Ÿæˆ
      const observer = new MutationObserver(callback);
  
      // å¯¾è±¡ãƒãƒ¼ãƒ‰ã®è¨­å®šã•ã‚ŒãŸå¤‰æ›´ã®ç›£è¦–ã‚’é–‹å§‹
      observer.observe(targetNode, config);
  
      // ãã®å¾Œã§ã€ç›£è¦–ã‚’åœæ­¢ã™ã‚‹ã“ã¨ãŒã§ãã‚‹
      // observer.disconnect();
    });
  </script>
  
  <body style="margin : 0px; overflow: hidden;">

    <div id="screen-text-overlay" style="
        /* é…ç½®ã¨ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯ãã®ã¾ã¾ */
        position: absolute; 
        
        /* ğŸ“Œ ä¿®æ­£ç‚¹ 1: bottom ã‚’æŒ‡å®š */
        bottom: 20px; /* ç”»é¢ä¸‹ç«¯ã‹ã‚‰ 20px ä¸Šã«é…ç½® */
        
        left: 50%; 
        transform: translateX(-50%); /* ä¸­å¤®æƒãˆã®ã¾ã¾ */
        z-index: 1000; 

        /* èƒŒæ™¯ã¨ãƒœãƒ¼ãƒ€ãƒ¼ã®è¨­å®š */
        color: white; 
        background-color: rgba(0, 0, 0, 0.8); 
        padding: 10px; 
        font-family: 'DotGothic16', sans-serif;
        border: 3px solid white; 
        border-radius: 8px; 

        display: none;
    ">
        <p id="typewriter-output"></p>
    </div>

    <div id="full-screen-overlay" style="
      position: absolute; 
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7); /* åŠé€æ˜ã®é»’ (70%ä¸é€æ˜åº¦) */
      z-index: 2000; /* ARã‚·ãƒ¼ãƒ³ã‚„ä»–ã®UIã‚ˆã‚Šé«˜ã */
      display: none; /* åˆæœŸçŠ¶æ…‹ã¯éè¡¨ç¤º */
      
      /* ãƒ†ã‚­ã‚¹ãƒˆé…ç½®ã®ãŸã‚ã®è¨­å®š */
      display: none; 
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      color: white;
      font-family: 'DotGothic16', sans-serif;
      font-size: 1.5em;
      pointer-events: auto; /* ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒ–ãƒ­ãƒƒã‚¯ã™ã‚‹ */
      ">
      <p id="guidance-text" style="
          background-color: rgba(255, 255, 255, 0.1); /* ãƒ†ã‚­ã‚¹ãƒˆèƒŒæ™¯ã‚’è–„ã */
          padding: 20px;
          border-radius: 10px;
      ">ãƒãƒ¼ã‚«ãƒ¼å…¨ä½“ã‚’ã‚«ãƒ¡ãƒ©ã«ç§»ã—ã¦ã­</p>
    </div>

    <div id="permission-denied-overlay" style="
        /* ç”»é¢å…¨ä½“ã‚’è¦†ã„ã€ä»–ã®è¦ç´ ã®ä¸Šã«é…ç½® */
        position: absolute; 
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        
        /* ğŸ“Œ èƒŒæ™¯ã¨ãƒ¬ã‚¤ãƒ¤ãƒ¼ */
        background-color: rgba(34, 34, 34, 0.95); /* æ¿ƒã„åŠé€æ˜ã®é»’ */
        color: white; 
        z-index: 99999; /* ä»–ã®ã©ã®UIã‚ˆã‚Šã‚‚é«˜ã„ãƒ¬ã‚¤ãƒ¤ãƒ¼ */
        
        /* ğŸ“Œ ä¸­å¤®é…ç½®ã¨ãƒ†ã‚­ã‚¹ãƒˆã‚¹ã‚¿ã‚¤ãƒ« */
        display: none; /* åˆæœŸçŠ¶æ…‹ã¯éè¡¨ç¤º (JSã§è¡¨ç¤ºã‚’åˆ¶å¾¡) */
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
        font-family: 'DotGothic16', sans-serif;
        padding: 20px;
    ">
        
        <h1 style="color: #FF6347; font-size: 2.2em; margin-bottom: 15px;">
            ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ ğŸš«
        </h1>
        
        <p id="denial-message" style="
            max-width: 80%;
            font-size: 1.2em;
            line-height: 1.8;
            padding: 15px;
            border: 2px solid #FF6347; /* ã‚¨ãƒ©ãƒ¼ã‚’ç¤ºã™èµ¤ã„æ ç·š */
            border-radius: 8px;
            background-color: rgba(255, 99, 71, 0.1); /* è–„ã„èµ¤ã®èƒŒæ™¯ */
        ">
            ARä½“é¨“ã‚’é–‹å§‹ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚<br><br>
            **è§£æ±ºæ–¹æ³•ï¼š**<br>
            1. ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šï¼ˆã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼ã®éµãƒãƒ¼ã‚¯ãªã©ï¼‰ã‚’é–‹ãã€‚<br>
            2. ã“ã®ã‚µã‚¤ãƒˆã®ã‚«ãƒ¡ãƒ©æ¨©é™ã‚’**ã€Œè¨±å¯ã€**ã«å¤‰æ›´ã™ã‚‹ã€‚<br>
            3. ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆå†èª­ã¿è¾¼ã¿ï¼‰ã—ã¦ãã ã•ã„ã€‚
        </p>

        <button onclick="window.location.reload();" style="
            padding: 12px 25px; 
            font-size: 1.1em; 
            margin-top: 30px;
            background-color: #4CAF50; /* è¨±å¯å¾Œã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä¿ƒã™ç·‘è‰² */
            color: white; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer;
        ">ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã™ã‚‹</button>

    </div>

    <div id="loading-overlay" style="
        /* ç”»é¢å…¨ä½“ã«å›ºå®š */
        position: fixed; 
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        
        /* èƒŒæ™¯ã¨ãƒ¬ã‚¤ãƒ¤ãƒ¼ */
        background-color: #1a1a1a; 
        color: #00ff88; 
        z-index: 9999; 
        
        /* ä¸­å¤®é…ç½® */
        display: flex; 
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
        
        /* ãƒ•ã‚©ãƒ³ãƒˆã‚¹ã‚¿ã‚¤ãƒ« */
        font-family: monospace, sans-serif; 
        font-size: 1.8em;
    ">
        <div id="spinner-container" style="
            border: 4px solid rgba(0, 255, 136, 0.2); /* è–„ã„ç·‘è‰²ã®æ  */
            border-top: 4px solid #00ff88; /* æ¿ƒã„ç·‘è‰²ã®ãƒˆãƒƒãƒ—æ  */
            border-radius: 50%; /* å®Œå…¨ãªå††å½¢ */
            width: 50px;
            height: 50px;
            margin-bottom: 20px;
            /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é©ç”¨ã™ã‚‹ãŸã‚ã®CSSã‚¯ãƒ©ã‚¹ã‚’JSã‹ã‚‰æ“ä½œã™ã‚‹ã‹ã€ã¾ãŸã¯å¤–éƒ¨/å†…éƒ¨<style>ã§é©ç”¨ */
            animation: spin 1s linear infinite; /* å¤–éƒ¨<style>ã§å®šç¾©ã™ã‚‹ */
        "></div>

        <div>RESOURCES LOADING...</div>
    </div>

    <style>
    /* =================================== */
    /* å¿…é ˆ: å›è»¢ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®å®šç¾© */
    /* =================================== */
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* âš ï¸ æ³¨æ„: id="spinner-container" ã«ç›´æ¥ animation ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’é©ç”¨ã™ã‚‹ä»£ã‚ã‚Šã«ã€
      ã“ã“ã§ã‚¯ãƒ©ã‚¹ã‚„IDã‚’ä½¿ã£ã¦ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é©ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã›ã‚“ã€‚
      ãã®ãŸã‚ã€ä¸Šè¨˜ã®HTMLã§ã¯ animation: spin 1s linear infinite; ã‚’ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã§è¨˜è¿°ã—ã¾ã—ãŸãŒã€
      ãƒ–ãƒ©ã‚¦ã‚¶ã«ã‚ˆã£ã¦ã¯ç„¡åŠ¹ã«ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ãã®å ´åˆã¯ã€ã“ã®<style>ãƒ–ãƒ­ãƒƒã‚¯ã«
      #spinner-container { animation: spin 1s linear infinite; } ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚ */

    /* =================================== */
    /* æ—¢å­˜ã®ãƒã‚ªãƒ³é¢¨ç‚¹æ»…åŠ¹æœ (ã‚ªãƒ—ã‚·ãƒ§ãƒ³) */
    /* =================================== */
    @keyframes pulse {
        from { box-shadow: 0 0 5px rgba(0, 255, 136, 0.5); }
        to { box-shadow: 0 0 20px rgba(0, 255, 136, 1.0); }
    }

    /* å¿…è¦ã«å¿œã˜ã¦ã€ãƒã‚ªãƒ³åŠ¹æœã‚’é©ç”¨ã—ãŸã„è¦ç´  (ä¾‹: #global-loader ã®ä¸­ã® div) ã«é©ç”¨ */
    #global-loader > div:nth-child(2) { /* RESOURCES LOADING... ã®ã‚³ãƒ³ãƒ†ãƒŠ */
        animation: pulse 1.5s infinite alternate;
    }
    </style>

    
    <a-scene embedded arjs="debugUIEnabled:false" device-orientation-permission-ui="enabled: false" renderer="logarithmicDepthBuffer: true" xr-mode-ui="enabled: false">
      <a-assets>
        <a-asset-item id="yuusya" src="assets/yuusya.glb"></a-asset-item>
        <a-asset-item id="kuma" src="assets/kuma.glb"></a-asset-item>
        <a-asset-item id="kenja" src="assets/kenja.glb"></a-asset-item>
      </a-assets>

      <!-- <a-marker type="pattern" url="kuma/kuma.patt" registerevents>
        <a-entity gltf-model="#yuusya" scale="0.5 0.5 0.5" animation-mixer></a-entity>
      </a-marker> -->

      <a-marker preset="hiro" registerevents id="yuusya">
        <a-entity gltf-model="#yuusya" scale="0.5 0.5 0.5" animation-mixer></a-entity>
      </a-marker>

      <a-marker preset="kanji" registerevents id="kuma">
        <a-entity gltf-model="#kuma" scale="0.5 0.5 0.5" animation-mixer></a-entity>
      </a-marker>


      <a-entity camera></a-entity>
      
    </a-scene>
  </body>

  <script>
  </script>
</html>
