<!DOCTYPE html>
<html>
  <head>
    <link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet">
  </head>
  
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <!-- we import arjs version without NFT but with marker + location based support -->
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
  <script src="https://cdn.rawgit.com/donmccurdy/aframe-extras/v5.0.0/dist/aframe-extras.min.js"></script>

  <script>

    let charIndex = 0;
    let IsmessageOn = true;

    let markerStatus = null;

    const messages = {
      'kenja': '勇者よ！ まさか本当に会えるとは....\n！我はドラゴンの盟友。召喚の儀式の全てを知る者だ\n\n賢者が仲間になった！\n\n\nキーワードは....「な」だ',
      'kuma': '我は運命の導き手！お前の中には、確かに誠実な心がある。力を貸そう。\n\n大精霊が仲間になった！\n\n\nキーワードは....「か」だ',
      'yuusya': '我は情熱を司る者！ドラゴンを召喚する志、気に入った！\n\n原初の炎が仲間になった！\n\n\nキーワードは....「ま」だ'
    }

    localStorage.setItem(getURLparam('char'), 1);
    
    AFRAME.registerComponent('registerevents', {
      init: function () {
        var marker = this.el;

        marker.addEventListener('markerFound', function() {
          var markerId = marker.id;
          console.log('markerFound', markerId);

          // TODO: Add your own code here to react to the marker being found.
          markerStatus = 'Found';

          hideelement('full-screen-overlay');
                    
          IsmessageOn = true;
          startTypewriter(messages[markerId]);
        });

        marker.addEventListener('markerLost', function() {
          var markerId = marker.id;
          console.log('markerLost', markerId);

          // TODO: Add your own code here to react to the marker being lost.
          markerStatus = 'Lost';
          
          showCameraGuide();
          IsmessageOn = false;
        });
      }
    });


    function startTypewriter(dialogue) {
      if (!IsmessageOn) {
        return;
      }
      showelement('screen-text-overlay');

      const outputElement = document.getElementById('typewriter-output');
      const speed = 150;
      
      if (charIndex < dialogue.length) {
        outputElement.innerText = dialogue.substring(0, charIndex + 1);
        
        charIndex++;
               
        setTimeout(() => {
          startTypewriter(dialogue); 
        }, speed);

      } else {
        return;
      }
    }
    
    function showCameraGuide() {
      setTimeout(() => {
          if (markerStatus === 'Lost') {
              showelement('full-screen-overlay'); 
          }
      }, 1000);
    }
    
    function showelement(id) {
      const element = document.getElementById(id);
      element.style.display = 'flex';
    }

    function hideelement(id) {
      const element = document.getElementById(id);
      element.style.display = 'none';
    }

    function getURLparam(id) {
      // 文字列としてURLを取得する。
      let url_string = window.location.href;
      // 文字列としてのURLをURLオブジェクトに変換する。
      let url = new URL(url_string);
      // URLオブジェクトのsearchParamsのget関数でIDがdの値を取得する。
      let data=url.searchParams.get(id);
      // "d"というIDが定義されていない場合はnullが入る

      return data;
    }

    function DeleteCharElm() {
      const char = getURLparam('char');

      const charList = ['kenja', 'kuma', 'yuusya'];
      const deleteLists = charList.filter(item => item != char);

      for (const deletelist of deleteLists) {
        document.getElementById(deletelist).remove();
        console.log(deletelist);
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      const targetNode = document.body;
  
      const config = { attributes: true, childList: true, subtree: true };
  
      const callback = (mutationList, observer) => {
        for (const mutation of mutationList) {
          mutation.addedNodes.forEach(node => {
            if (node.id == 'error-popup') {
              console.log('error-popupを発見しました！');

              hideelement(node.id);
              showelement('permission-denied-overlay');

              hideelement('loading-overlay');
              observer.disconnect();
              return;
              
            } else if (node.id == 'arjs-video') {
              console.log('video要素を発見しました');
              
              showelement('full-screen-overlay');
              hideelement('loading-overlay');

              observer.disconnect();
              return;
            }
          });
        }
      };
  
      const observer = new MutationObserver(callback);
  
      observer.observe(targetNode, config);
    });
    
    //DOMContentLoadedからloadedに変更する
    document.addEventListener('DOMContentLoaded', DeleteCharElm);
  </script>
  
  <body style="margin : 0px; overflow: hidden;">

    <div id="screen-text-overlay" style="
        /* 配置とレイヤーはそのまま */
        position: absolute; 
        
        /* 📌 修正点 1: bottom を指定 */
        bottom: 20px; /* 画面下端から 20px 上に配置 */
        
        left: 50%; 
        transform: translateX(-50%); /* 中央揃えのまま */
        z-index: 1000; 

        /* 背景とボーダーの設定 */
        color: white; 
        background-color: rgba(0, 0, 0, 0.8); 
        padding: 10px; 
        font-family: 'DotGothic16', sans-serif;
        border: 3px solid white; 
        border-radius: 8px; 

        display: none;
    ">
        <p id="typewriter-output"></p>
    </div>

    <div id="full-screen-overlay" style="
      position: absolute; 
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7); /* 半透明の黒 (70%不透明度) */
      z-index: 2000; /* ARシーンや他のUIより高く */
      display: none; /* 初期状態は非表示 */
      
      /* テキスト配置のための設定 */
      display: none; 
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      color: white;
      font-family: 'DotGothic16', sans-serif;
      font-size: 1.5em;
      pointer-events: auto; /* タッチイベントをブロックする */
      ">
      <p id="guidance-text" style="
          background-color: rgba(255, 255, 255, 0.1); /* テキスト背景を薄く */
          padding: 20px;
          border-radius: 10px;
      ">QRコードをカメラにかざしてね</p>
    </div>

    <div id="permission-denied-overlay" style="
        /* 画面全体を覆い、他の要素の上に配置 */
        position: absolute; 
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        
        /* 📌 背景とレイヤー */
        background-color: rgba(34, 34, 34, 0.95); /* 濃い半透明の黒 */
        color: white; 
        z-index: 99999; /* 他のどのUIよりも高いレイヤー */
        
        /* 📌 中央配置とテキストスタイル */
        display: none; /* 初期状態は非表示 (JSで表示を制御) */
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
        font-family: 'DotGothic16', sans-serif;
        padding: 20px;
    ">
        
        <h1 style="color: #FF6347; font-size: 2.2em; margin-bottom: 15px;">
            カメラアクセスが拒否されました 🚫
        </h1>
        
        <p id="denial-message" style="
            max-width: 80%;
            font-size: 1.2em;
            line-height: 1.8;
            padding: 15px;
            border: 2px solid #FF6347; /* エラーを示す赤い枠線 */
            border-radius: 8px;
            background-color: rgba(255, 99, 71, 0.1); /* 薄い赤の背景 */
        ">
            AR体験を開始できませんでした。<br><br>
            **解決方法：**<br>
            1. ブラウザの設定（アドレスバーの鍵マークなど）を開く。<br>
            2. このサイトのカメラ権限を**「許可」**に変更する。<br>
            3. ページをリロード（再読み込み）してください。
        </p>

        <button onclick="window.location.reload();" style="
            padding: 12px 25px; 
            font-size: 1.1em; 
            margin-top: 30px;
            background-color: #4CAF50; /* 許可後のアクションを促す緑色 */
            color: white; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer;
        ">ページをリロードする</button>

    </div>

    <div id="loading-overlay" style="
        /* 画面全体に固定 */
        position: fixed; 
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        
        /* 背景とレイヤー */
        background-color: #1a1a1a; 
        color: #00ff88; 
        z-index: 9999; 
        
        /* 中央配置 */
        display: flex; 
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
        
        /* フォントスタイル */
        font-family: monospace, sans-serif; 
        font-size: 1.8em;
    ">
        <div id="spinner-container" style="
            border: 4px solid rgba(0, 255, 136, 0.2); /* 薄い緑色の枠 */
            border-top: 4px solid #00ff88; /* 濃い緑色のトップ枠 */
            border-radius: 50%; /* 完全な円形 */
            width: 50px;
            height: 50px;
            margin-bottom: 20px;
            /* アニメーションを適用するためのCSSクラスをJSから操作するか、または外部/内部<style>で適用 */
            animation: spin 1s linear infinite; /* 外部<style>で定義する */
        "></div>

        <div>読み込み中...</div>
    </div>

    <style>
    /* =================================== */
    /* 必須: 回転アニメーションの定義 */
    /* =================================== */
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* ⚠️ 注意: id="spinner-container" に直接 animation プロパティを適用する代わりに、
      ここでクラスやIDを使ってアニメーションを適用することができません。
      そのため、上記のHTMLでは animation: spin 1s linear infinite; をインラインで記述しましたが、
      ブラウザによっては無効になる可能性があります。その場合は、この<style>ブロックに
      #spinner-container { animation: spin 1s linear infinite; } を追加してください。 */

    /* =================================== */
    /* 既存のネオン風点滅効果 (オプション) */
    /* =================================== */
    @keyframes pulse {
        from { box-shadow: 0 0 5px rgba(0, 255, 136, 0.5); }
        to { box-shadow: 0 0 20px rgba(0, 255, 136, 1.0); }
    }

    /* 必要に応じて、ネオン効果を適用したい要素 (例: #global-loader の中の div) に適用 */
    #global-loader > div:nth-child(2) { /* RESOURCES LOADING... のコンテナ */
        animation: pulse 1.5s infinite alternate;
    }
    </style>

    
    <a-scene embedded arjs="debugUIEnabled:false;" device-orientation-permission-ui="enabled: false" renderer="logarithmicDepthBuffer: true" xr-mode-ui="enabled: false">
      <a-assets id="assets">
        <a-asset-item id="yuusya" src="assets/yuusya.glb"></a-asset-item>
        <a-asset-item id="kuma" src="assets/kuma.glb"></a-asset-item>
        <a-asset-item id="kenja" src="assets/kenja.glb"></a-asset-item>
        
        <a-asset-item id="bpenlight" src="assets/SubAssets/bpenlight.glb"></a-asset-item>
        <a-asset-item id="gpenlight" src="assets/SubAssets/gpenlight.glb"></a-asset-item>
        <a-asset-item id="heroo" src="assets/SubAssets/heroo.glb"></a-asset-item>
        <a-asset-item id="muki" src="assets/SubAssets/muki.glb"></a-asset-item>
        <a-asset-item id="openlight" src="assets/SubAssets/openlight.glb"></a-asset-item>
        <a-asset-item id="penlight" src="assets/SubAssets/penlight.glb"></a-asset-item>
        <a-asset-item id="ppenlight" src="assets/SubAssets/ppenlight.glb"></a-asset-item>
        <a-asset-item id="spenlight" src="assets/SubAssets/spenlight.glb"></a-asset-item>
        <a-asset-item id="star" src="assets/SubAssets/star.glb"></a-asset-item>
        <a-asset-item id="wpenlight" src="assets/SubAssets/wpenlight.glb"></a-asset-item>
        <a-asset-item id="ypenlight" src="assets/SubAssets/ypenlight.glb"></a-asset-item>      
      </a-assets>
<!-- 
      <a-marker type='barcode' value='0' registerevents id="yuusya">
        <a-entity gltf-model="#yuusya" scale="1 1 1" animation-mixer></a-entity>
      </a-marker>

      <a-marker type='barcode' value='1' registerevents id="kuma">
        <a-entity gltf-model="#kuma" scale="1 1 1" animation-mixer></a-entity>
      </a-marker>

      <a-marker type='barcode' value='2' registerevents id="kenja">
        <a-entity gltf-model="#kenja" scale="1 1 1" animation-mixer></a-entity>
      </a-marker>
 -->
      <a-marker type="pattern" url="patt\pattern-yuusya.patt" registerevents id="yuusya">
        <a-entity gltf-model="#yuusya" scale="0.25 0.25 0.25" animation-mixer></a-entity>

        <a-entity gltf-model="#muki" scale="0.00125 0.00125 0.00125" animation-mixer position="1.00 0 0.00" rotation="0 0 0"></a-entity>
        
        <a-entity gltf-model="#gpenlight" scale="0.025 0.025 0.025" animation-mixer position="0.87 0 0.50" rotation="0 30 0"></a-entity>
        
        <a-entity gltf-model="#heroo" scale="0.125 0.125 0.125" animation-mixer position="-1.00 0 0.00" rotation="0 0 0"></a-entity>
        
        <a-entity gltf-model="#bpenlight" scale="0.025 0.025 0.025" animation-mixer position="0.00 0 -1.00" rotation="0 90 0"></a-entity>

        <a-entity gltf-model="#openlight" scale="0.025 0.025 0.025" animation-mixer position="-0.50 0 0.87" rotation="0 120 0"></a-entity>

        <a-entity gltf-model="#openlight" scale="0.025 0.025 0.025" animation-mixer position="-0.87 0 0.50" rotation="0 150 0"></a-entity>
        
        <a-entity gltf-model="#penlight" scale="0.025 0.025 0.025" animation-mixer position="0.50 0 0.87" rotation="0 180 0"></a-entity>
        
        <a-entity gltf-model="#ppenlight" scale="0.025 0.025 0.025" animation-mixer position="-0.87 0 -0.50" rotation="0 210 0"></a-entity>
        
        <a-entity gltf-model="#spenlight" scale="0.025 0.025 0.025" animation-mixer position="-0.50 0 -0.87" rotation="0 240 0"></a-entity>
        
        <a-entity gltf-model="#star" scale="0.025 0.025 0.025" animation-mixer position="0.00 0 1.00" rotation="0 270 0"></a-entity>
        
        <a-entity gltf-model="#wpenlight" scale="0.025 0.025 0.025" animation-mixer position="0.50 0 -0.87" rotation="0 300 0"></a-entity>
        
        <a-entity gltf-model="#ypenlight" scale="0.025 0.025 0.025" animation-mixer position="0.87 0 -0.50" rotation="0 330 0"></a-entity>

      </a-marker>

      <a-marker type="pattern" url="patt\pattern-kuma.patt" registerevents id="kuma">
        <a-entity gltf-model="#kuma" scale="0.25 0.25 0.25" animation-mixer></a-entity>

        <a-entity gltf-model="#muki" scale="0.00125 0.00125 0.00125" animation-mixer position="1.00 0 0.00" rotation="0 0 0"></a-entity>
        
        <a-entity gltf-model="#gpenlight" scale="0.025 0.025 0.025" animation-mixer position="0.87 0 0.50" rotation="0 30 0"></a-entity>
        
        <a-entity gltf-model="#heroo" scale="0.125 0.125 0.125" animation-mixer position="-1.00 0 0.00" rotation="0 0 0"></a-entity>
        
        <a-entity gltf-model="#bpenlight" scale="0.025 0.025 0.025" animation-mixer position="0.00 0 -1.00" rotation="0 90 0"></a-entity>

        <a-entity gltf-model="#openlight" scale="0.025 0.025 0.025" animation-mixer position="-0.50 0 0.87" rotation="0 120 0"></a-entity>

        <a-entity gltf-model="#openlight" scale="0.025 0.025 0.025" animation-mixer position="-0.87 0 0.50" rotation="0 150 0"></a-entity>
        
        <a-entity gltf-model="#penlight" scale="0.025 0.025 0.025" animation-mixer position="0.50 0 0.87" rotation="0 180 0"></a-entity>
        
        <a-entity gltf-model="#ppenlight" scale="0.025 0.025 0.025" animation-mixer position="-0.87 0 -0.50" rotation="0 210 0"></a-entity>
        
        <a-entity gltf-model="#spenlight" scale="0.025 0.025 0.025" animation-mixer position="-0.50 0 -0.87" rotation="0 240 0"></a-entity>
        
        <a-entity gltf-model="#star" scale="0.025 0.025 0.025" animation-mixer position="0.00 0 1.00" rotation="0 270 0"></a-entity>
        
        <a-entity gltf-model="#wpenlight" scale="0.025 0.025 0.025" animation-mixer position="0.50 0 -0.87" rotation="0 300 0"></a-entity>
        
        <a-entity gltf-model="#ypenlight" scale="0.025 0.025 0.025" animation-mixer position="0.87 0 -0.50" rotation="0 330 0"></a-entity>

      </a-marker>

      <a-marker type="pattern" url="patt\pattern-kenja.patt" registerevents id="kenja">
        <a-entity gltf-model="#kenja" scale="0.25 0.25 0.25" rotation="0 180 0" animation-mixer></a-entity>

        <a-entity gltf-model="#muki" scale="0.00125 0.00125 0.00125" animation-mixer position="1.00 0 0.00" rotation="0 0 0"></a-entity>
        
        <a-entity gltf-model="#gpenlight" scale="0.025 0.025 0.025" animation-mixer position="0.87 0 0.50" rotation="0 30 0"></a-entity>
        
        <a-entity gltf-model="#heroo" scale="0.125 0.125 0.125" animation-mixer position="-1.00 0 0.00" rotation="0 0 0"></a-entity>
        
        <a-entity gltf-model="#bpenlight" scale="0.025 0.025 0.025" animation-mixer position="0.00 0 -1.00" rotation="0 90 0"></a-entity>

        <a-entity gltf-model="#openlight" scale="0.025 0.025 0.025" animation-mixer position="-0.50 0 0.87" rotation="0 120 0"></a-entity>

        <a-entity gltf-model="#openlight" scale="0.025 0.025 0.025" animation-mixer position="-0.87 0 0.50" rotation="0 150 0"></a-entity>
        
        <a-entity gltf-model="#penlight" scale="0.025 0.025 0.025" animation-mixer position="0.50 0 0.87" rotation="0 180 0"></a-entity>
        
        <a-entity gltf-model="#ppenlight" scale="0.025 0.025 0.025" animation-mixer position="-0.87 0 -0.50" rotation="0 210 0"></a-entity>
        
        <a-entity gltf-model="#spenlight" scale="0.025 0.025 0.025" animation-mixer position="-0.50 0 -0.87" rotation="0 240 0"></a-entity>
        
        <a-entity gltf-model="#star" scale="0.025 0.025 0.025" animation-mixer position="0.00 0 1.00" rotation="0 270 0"></a-entity>
        
        <a-entity gltf-model="#wpenlight" scale="0.025 0.025 0.025" animation-mixer position="0.50 0 -0.87" rotation="0 300 0"></a-entity>
        
        <a-entity gltf-model="#ypenlight" scale="0.025 0.025 0.025" animation-mixer position="0.87 0 -0.50" rotation="0 330 0"></a-entity>

      </a-marker>


      <a-entity camera></a-entity>
      
    </a-scene>
  </body>

  <script>
    DeleteCharElm()
  </script>
</html>
